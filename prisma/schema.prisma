generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StageType {
  GROUP
  R32
  R16
  QF
  SF
  THIRD
  FINAL
}

enum FixtureStatus {
  SCHEDULED
  FINISHED
  POSTPONED
  CANCELLED
}

enum PredictionOutcome {
  HOME_WIN
  DRAW
  AWAY_WIN
  HOME_FT
  HOME_ET
  HOME_PENS
  AWAY_FT
  AWAY_ET
  AWAY_PENS
  DRAW_FT
  DRAW_ET
}

enum LeagueRole {
  OWNER
  MEMBER
}

model User {
  id                    String                    @id @default(cuid())
  email                 String                    @unique
  passwordHash          String
  displayName           String
  isAdmin               Boolean                   @default(false)
  predictions           Prediction[]
  extraPredictions      ExtraPrediction[]
  preTournamentPicks    PreTournamentPrediction[]
  paymentStatuses       PaymentStatus[]
  pointsAwards          PointsAward[]
  leaguesCreated        League[]                  @relation("LeagueOwner")
  leagueMemberships     LeagueMember[]
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
}

model Competition {
  id                    String                    @id
  name                  String
  isActive              Boolean                   @default(false)
  rounds                Round[]
  fixtures              Fixture[]
  teams                 Team[]
  paymentStatuses       PaymentStatus[]
  preTournamentPicks    PreTournamentPrediction[]
  leagues               League[]
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
}

model Team {
  id                    String                    @id @default(cuid())
  competitionId         String
  name                  String
  competition           Competition               @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  homeFixtures          Fixture[]                 @relation("HomeTeam")
  awayFixtures          Fixture[]                 @relation("AwayTeam")

  @@unique([competitionId, name])
}

model Round {
  id                    String                    @id @default(cuid())
  competitionId         String
  name                  String
  stageType             StageType
  roundNumber           Int?
  sortOrder             Int
  lockAtUtc             DateTime
  competition           Competition               @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  fixtures              Fixture[]

  @@unique([competitionId, name])
}

model Fixture {
  id                    String                    @id @default(cuid())
  competitionId         String
  roundId               String
  fixtureNumber         Int
  kickoffAtUtc          DateTime
  stageType             StageType
  groupLabel            String?
  homeTeamId            String
  awayTeamId            String
  stadiumId             String?
  creator               String?
  uniqueImportId        String?
  competition           Competition               @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  round                 Round                     @relation(fields: [roundId], references: [id], onDelete: Cascade)
  homeTeam              Team                      @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Restrict)
  awayTeam              Team                      @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Restrict)
  result                MatchResult?
  predictions           Prediction[]
  extraPredictions      ExtraPrediction[]
  pointsAwards          PointsAward[]

  @@unique([competitionId, fixtureNumber])
}

model MatchResult {
  id                    String                    @id @default(cuid())
  fixtureId             String                    @unique
  status                FixtureStatus             @default(SCHEDULED)
  homeFtGoals           Int?
  awayFtGoals           Int?
  homeEtGoals           Int?
  awayEtGoals           Int?
  wentToPens            Boolean                   @default(false)
  pensWinnerTeamId      String?
  officialManOfMatch    String?
  openingGoalMinuteActual Int?
  fixture               Fixture                   @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
}

model Prediction {
  id                    String                    @id @default(cuid())
  userId                String
  fixtureId             String
  outcome               PredictionOutcome
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fixture               Fixture                   @relation(fields: [fixtureId], references: [id], onDelete: Cascade)

  @@unique([userId, fixtureId])
}

model ExtraPrediction {
  id                    String                    @id @default(cuid())
  userId                String
  fixtureId             String
  goldenGoalMinute      Int?
  noGoal                Boolean                   @default(false)
  manOfMatch            String?
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fixture               Fixture                   @relation(fields: [fixtureId], references: [id], onDelete: Cascade)

  @@unique([userId, fixtureId])
}

model PreTournamentPrediction {
  id                    String                    @id @default(cuid())
  userId                String
  competitionId         String
  winnerTeam            String?
  goldenBootPlayer      String?
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  competition           Competition               @relation(fields: [competitionId], references: [id], onDelete: Cascade)
}

model PaymentStatus {
  id                    String                    @id @default(cuid())
  userId                String
  competitionId         String
  isPaid                Boolean                   @default(false)
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  competition           Competition               @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([userId, competitionId])
}

model PointsAward {
  id                    String                    @id @default(cuid())
  userId                String
  fixtureId             String?
  roundId               String?
  competitionId         String
  category              String
  points                Int
  metadata              Json?
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fixture               Fixture?                  @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
}

model League {
  id                    String                    @id @default(cuid())
  competitionId         String
  name                  String
  createdByUserId       String
  joinCode              String                    @unique
  competition           Competition               @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  creator               User                      @relation("LeagueOwner", fields: [createdByUserId], references: [id], onDelete: Cascade)
  members               LeagueMember[]
}

model LeagueMember {
  id                    String                    @id @default(cuid())
  leagueId              String
  userId                String
  role                  LeagueRole                @default(MEMBER)
  league                League                    @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId])
}
